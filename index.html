<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DASBOARD ADMIN CUTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f5f8;
  margin: 0;
  padding: 14px;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
}
.table-wrapper {
  overflow-x: auto;
  background: #fff;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1800px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 12px;
  white-space: nowrap;
  text-align: center;
}
th {
  background: #0d6efd;
  color: #fff;
}
input, select {
  font-size: 12px;
  padding: 4px;
}
button {
  padding: 5px 8px;
  border: none;
  border-radius: 4px;
  color: #fff;
  cursor: pointer;
}
.btn-save { background: #198754; }
.btn-delete { background: #dc3545; }
a { color: #0d6efd; }
</style>
</head>

<body>

<h1>DASBOARD ADMIN CUTI</h1>

<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>ID</th>
  <th>Created At</th>
  <th>Nama</th>
  <th>NIP</th>
  <th>No HP</th>
  <th>Jenis Cuti</th>
  <th>Tgl Mulai</th>
  <th>Lama Cuti</th>
  <th>Alamat</th>
  <th>File 1</th>
  <th>File 2</th>
  <th>Signature</th>
  <th>Status</th>
  <th>Nomor Surat</th>
  <th>Cuti Bersama</th>
  <th>Tgl Selesai</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
/* =============================
   KONFIGURASI SUPABASE
============================= */
const SUPABASE_URL = "https://ufiqibxdgwlysqhinqbz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =============================
   LOAD DATA (SEMUA KOLOM)
============================= */
async function loadData() {
  const { data, error } = await supabase
    .from("pengajuan_cuti")
    .select(`
      id,
      created_at,
      nama,
      nip,
      no_hp,
      jenis_cuti,
      tgl_mulai,
      lama_cuti,
      alamat,
      file_1_url,
      file_2_url,
      signature_url,
      status,
      nomor_surat,
      cuti_bersama,
      tgl_selesai
    `)
    .order("created_at", { ascending: false });

  if (error) {
    alert("ERROR LOAD DATA: " + error.message);
    return;
  }

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.created_at || ""}</td>
      <td>${row.nama || ""}</td>
      <td>${row.nip || ""}</td>
      <td>${row.no_hp || ""}</td>
      <td>${row.jenis_cuti || ""}</td>
      <td>${row.tgl_mulai || ""}</td>
      <td>${row.lama_cuti || ""}</td>
      <td>${row.alamat || ""}</td>

      <td>${row.file_1_url ? `<a href="${row.file_1_url}" target="_blank">Lihat</a>` : "-"}</td>
      <td>${row.file_2_url ? `<a href="${row.file_2_url}" target="_blank">Lihat</a>` : "-"}</td>
      <td>${row.signature_url ? `<a href="${row.signature_url}" target="_blank">Lihat</a>` : "-"}</td>

      <td>
        <select id="status_${row.id}">
          <option ${row.status === "Diajukan" ? "selected" : ""}>Diajukan</option>
          <option ${row.status === "Disetujui" ? "selected" : ""}>Disetujui</option>
          <option ${row.status === "Ditolak" ? "selected" : ""}>Ditolak</option>
        </select>
      </td>

      <td>${row.nomor_surat || ""}</td>

      <td>
        <select id="cb_${row.id}">
          <option value="0" ${row.cuti_bersama == 0 ? "selected" : ""}>Tidak</option>
          <option value="1" ${row.cuti_bersama == 1 ? "selected" : ""}>Ya</option>
        </select>
      </td>

      <td>
        <input type="date" id="tgl_${row.id}" value="${row.tgl_selesai || ""}">
      </td>

      <td>
        <button class="btn-save" onclick="updateRow('${row.id}')">Simpan</button>
        <button class="btn-delete" onclick='deleteRow(${JSON.stringify(row)})'>Hapus</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* =============================
   UPDATE DATA (3 KOLOM SAJA)
============================= */
async function updateRow(id) {
  const status = document.getElementById("status_" + id).value;
  const cuti_bersama = parseInt(document.getElementById("cb_" + id).value);
  const tgl_selesai = document.getElementById("tgl_" + id).value;

  const { error } = await supabase
    .from("pengajuan_cuti")
    .update({
      status: status,
      cuti_bersama: cuti_bersama,
      tgl_selesai: tgl_selesai
    })
    .eq("id", id);

  if (error) {
    alert("GAGAL UPDATE: " + error.message);
  } else {
    alert("Data berhasil diperbarui");
  }
}

/* =============================
   HAPUS DATA + STORAGE
============================= */
async function deleteRow(row) {
  if (!confirm("Yakin hapus data ini beserta file di storage?")) return;

  await deleteFile(row.file_1_url, "cuti-pdf");
  await deleteFile(row.file_2_url, "cuti-pdf");
  await deleteFile(row.signature_url, "cuti-signature");

  const { error } = await supabase
    .from("pengajuan_cuti")
    .delete()
    .eq("id", row.id);

  if (error) {
    alert("GAGAL HAPUS: " + error.message);
  } else {
    alert("Data & file berhasil dihapus");
    loadData();
  }
}

/* =============================
   HAPUS FILE STORAGE
============================= */
async function deleteFile(url, bucket) {
  if (!url) return;
  const path = url.split("/" + bucket + "/")[1];
  if (!path) return;

  await supabase.storage.from(bucket).remove([path]);
}

/* =============================
   INIT
============================= */
loadData();
</script>

</body>
</html>
