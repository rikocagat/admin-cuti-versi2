<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DASBOARD ADMIN CUTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f5f8;
  margin: 0;
  padding: 14px;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
}
.table-wrapper {
  overflow-x: auto;
  background: #fff;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1800px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 12px;
  white-space: nowrap;
  text-align: center;
}
th {
  background: #0d6efd;
  color: #fff;
}
input, select {
  font-size: 12px;
  padding: 4px;
}
button {
  padding: 5px 8px;
  border: none;
  border-radius: 4px;
  color: #fff;
  cursor: pointer;
}
.btn-save { background: #198754; }
.btn-delete { background: #dc3545; }
a { color: #0d6efd; }
</style>
</head>

<body>

<h1>DASBOARD ADMIN CUTI</h1>

<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>Nama</th>
  <th>Tgl Mulai</th>
  <th>Lama Cuti</th>
  <th>Cuti Bersama</th>
  <th>Tgl Selesai</th>
  <th>Status</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
/* =============================
   KONFIGURASI SUPABASE
============================= */
const SUPABASE_URL = "https://ufiqibxdgwlysqhinqbz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =============================
   FUNGSI HITUNG TANGGAL SELESAI
============================= */
function hitungTanggalSelesai(tglMulai, lamaCuti, cutiBersama) {
  let tanggal = new Date(tglMulai);
  let hariTerhitung = 0;

  while (hariTerhitung < lamaCuti) {
    const day = tanggal.getDay();

    if (day !== 0 && day !== 6) {
      hariTerhitung++;
    }
    if (hariTerhitung < lamaCuti) {
      tanggal.setDate(tanggal.getDate() + 1);
    }
  }

  if (cutiBersama === 1) {
    tanggal.setDate(tanggal.getDate() + 1);
  }

  const yyyy = tanggal.getFullYear();
  const mm = String(tanggal.getMonth() + 1).padStart(2, '0');
  const dd = String(tanggal.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

/* =============================
   LOAD DATA
============================= */
async function loadData() {
  const { data, error } = await supabaseClient
    .from("pengajuan_cuti")
    .select("id,nama,tgl_mulai,lama_cuti,cuti_bersama,tgl_selesai,status")
    .order("created_at", { ascending: false });

  if (error) {
    alert(error.message);
    return;
  }

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.nama}</td>
      <td>${row.tgl_mulai}</td>
      <td>${row.lama_cuti}</td>
      <td>
        <select id="cb_${row.id}">
          <option value="0" ${row.cuti_bersama == 0 ? "selected" : ""}>Tidak</option>
          <option value="1" ${row.cuti_bersama == 1 ? "selected" : ""}>Ya</option>
        </select>
      </td>
      <td id="tgl_${row.id}">${row.tgl_selesai || "-"}</td>
      <td>
        <select id="status_${row.id}">
          <option ${row.status === "Diajukan" ? "selected" : ""}>Diajukan</option>
          <option ${row.status === "Disetujui" ? "selected" : ""}>Disetujui</option>
          <option ${row.status === "Ditolak" ? "selected" : ""}>Ditolak</option>
        </select>
      </td>
      <td>
        <button class="btn-save" onclick="updateRow('${row.id}','${row.tgl_mulai}',${row.lama_cuti})">Simpan</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* =============================
   UPDATE DATA
============================= */
async function updateRow(id, tglMulai, lamaCuti) {
  const status = document.getElementById("status_" + id).value;
  const cutiBersama = parseInt(document.getElementById("cb_" + id).value);

  const tglSelesai = hitungTanggalSelesai(
    tglMulai,
    lamaCuti,
    cutiBersama
  );

  const { error } = await supabaseClient
    .from("pengajuan_cuti")
    .update({
      status: status,
      cuti_bersama: cutiBersama,
      tgl_selesai: tglSelesai
    })
    .eq("id", id);

  if (error) {
    alert(error.message);
  } else {
    document.getElementById("tgl_" + id).innerText = tglSelesai;
    alert("Data berhasil diperbarui");
  }
}

/* =============================
   INIT
============================= */
loadData();
</script>

</body>
</html>
