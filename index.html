<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DASBOARD ADMIN CUTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== CSS ASLI TIDAK DIUBAH ===== */
body{font-family:"Segoe UI",Arial,sans-serif;background:#eef1f5;margin:0}
header{display:flex;align-items:center;justify-content:space-between;background:#0d6efd;color:#fff;padding:14px 20px}
header .left{display:flex;align-items:center;gap:12px}
.hamburger{font-size:22px;cursor:pointer}
.back-btn{background:#fff;color:#0d6efd;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:600}
main{padding:20px}
.search-box{max-width:700px;margin:0 auto 15px;position:relative}
.search-box input{width:100%;padding:12px;font-size:16px}
.suggestions{position:absolute;background:#fff;width:100%;border:1px solid #ccc;max-height:220px;overflow-y:auto;z-index:100}
.suggestions div{padding:8px;cursor:pointer}
.suggestions div:hover{background:#e9ecef}
.card{background:#fff;max-width:1300px;margin:20px auto;padding:28px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px 40px}
.label{font-weight:600;margin-bottom:6px}
input{width:100%;padding:10px;font-size:16px}
.highlight{background:#f8f9ff;padding:14px;border-radius:10px;border:1px solid #dbe1ff}
.files{margin-top:20px;padding-top:15px;border-top:1px solid #ddd}
.files-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
.files a{color:#0d6efd;font-weight:600}
.actions{margin-top:24px;display:flex;gap:12px;flex-wrap:wrap}
.btn{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;color:#fff;font-size:16px}
.btn-save{background:#198754}
.btn-doc{background:#6f42c1}
.btn-nav{background:#0d6efd}
.btn-del{background:#dc3545}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.loading{display:none;margin-top:12px;font-weight:bold;color:#6f42c1}
.doc-link{margin-top:10px;font-weight:600}
  .toast{
  position:fixed;
  bottom:24px;
  right:24px;
  background:#198754;
  color:#fff;
  padding:14px 20px;
  border-radius:10px;
  font-weight:600;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
  opacity:0;
  transform:translateY(20px);
  transition:.3s ease;
  z-index:9999;
}
.toast.show{
  opacity:1;
  transform:translateY(0);
}
.toast.error{
  background:#dc3545;
}
</style>
</head>

<body>

<header>
  <div class="left">
    <span class="hamburger">‚ò∞</span>
    <a class="back-btn" href="https://rikoantah.github.io/Dasboard-Kepegawaian/">‚Üê Back</a>
  </div>
  <h2>DASBOARD ADMIN CUTI</h2>
</header>

<main>

<div class="search-box">
  <input type="text" id="search" placeholder="Cari nama pegawai...">
  <div class="suggestions" id="suggestions"></div>
</div>

<div class="card" id="card"></div>

<div class="actions" style="justify-content:center">
  <button class="btn btn-nav" onclick="prevData()">‚óÄ Sebelumnya</button>
  <button class="btn btn-nav" onclick="nextData()">Berikutnya ‚ñ∂</button>
</div>

</main>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL="https://ufiqibxdgwlysqhinqbz.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL";
const GAS_URL="https://script.google.com/macros/s/AKfycbyjE3UkCsNGW9iFNRUdJvVaZD8LVj3V4tcLpDwYwXqQ9mTN9jveTu5mrOq_UXaQ4T6i/exec";

const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let dataList=[],index=0;

/* === TAMBAHAN PENTING (LINK DOKUMEN) === */
let lastDocUrl="";
let lastDocName="";

/* ================= HITUNG AKHIR CUTI ================= */
function hitungAkhir(tglMulai,lama,cb){
  let t=new Date(tglMulai),h=0;
  while(h<lama){
    let d=t.getDay();
    if(d!==0&&d!==6)h++;
    if(h<lama)t.setDate(t.getDate()+1);
  }
  let add=parseInt(cb||0);
  while(add>0){
    t.setDate(t.getDate()+1);
    let d=t.getDay();
    if(d!==0&&d!==6)add--;
  }
  return t.toISOString().split("T")[0];
}

/* ================= LOAD DATA ================= */
async function loadAll(){
  const { data } = await supabaseClient
    .from("pengajuan_cuti")
    .select("*")
    .order("created_at", { ascending: false });

  dataList = data || [];
  index = 0;

  render();
  setupSearch(); // ‚Üê WAJIB
}
/* ================= RENDER ================= */
function render(){
  const d = dataList[index];
  if(!d){
    card.innerHTML = "<b>Tidak ada data</b>";
    return;
  }

  const akhir = d.tgl_selesai || hitungAkhir(
    d.tgl_mulai,
    d.lama_cuti,
    d.cuti_bersama
  );

  card.innerHTML = `
  <div class="grid">
    <!-- KIRI -->
    <div>
      <div class="label">Nama</div>
      <input id="nama" value="${d.nama}">
    </div>
    <div>
      <div class="label">Nomor Surat</div>
      <input id="nomor_surat" value="${d.nomor_surat||""}">
    </div>

    <div>
      <div class="label">NIP</div>
      <input id="nip" value="${d.nip}">
    </div>
    <div>
      <div class="label">Awal Cuti</div>
      <input id="tgl_mulai" type="date" value="${d.tgl_mulai}">
    </div>

    <div>
      <div class="label">Jabatan</div>
      <input id="jabatan" value="${d.jabatan||""}">
    </div>
    <div>
      <div class="label">Akhir Cuti</div>
      <input id="akhir" value="${akhir}">
    </div>

    <div>
      <div class="label">Jenis Cuti</div>
      <input id="jenis_cuti" value="${d.jenis_cuti}">
    </div>
    <div>
      <div class="label">Lama Cuti</div>
      <input id="lama_cuti" type="number" value="${d.lama_cuti}">
    </div>

    <div>
      <div class="label">Alamat</div>
      <input id="alamat" value="${d.alamat||""}">
    </div>
    <div>
      <div class="label">Sisa Cuti</div>
      <input id="sisa_cuti" value="${d.sisa_cuti||""}">
    </div>

    <div>
      <div class="label">No HP</div>
      <input id="no_hp" value="${d.no_hp||""}">
    </div>
    <div>
      <div class="label">Cuti Bersama</div>
      <input id="cb" type="number" value="${d.cuti_bersama||0}">
    </div>
  </div>

  <div class="files">
    <div class="label">Berkas & Tanda Tangan</div>
    <div class="files-grid">
      <div>${d.file_1_url ? `<a href="${d.file_1_url}" target="_blank">Persyaratan 1</a>` : "-"}</div>
      <div>${d.file_2_url ? `<a href="${d.file_2_url}" target="_blank">Persyaratan 2</a>` : "-"}</div>
      <div>${d.signature_url ? `<a href="${d.signature_url}" target="_blank">TTD</a>` : "-"}</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-save" onclick="simpan()">Simpan</button>
    <button class="btn btn-doc" onclick="buatDokumen(1)">Buat Dokumen V1</button>
    <button class="btn btn-doc" onclick="buatDokumen(2)">Buat Dokumen V2</button>
    <button class="btn btn-nav" onclick="bukaDokTerakhir()">üìÇ Buka Dokumen Terakhir</button>
    <button class="btn btn-del" onclick="hapusData()">Hapus Data</button>
  </div>

  <div class="loading" id="loading">‚è≥ Membuat dokumen...</div>
  <div class="doc-link" id="docLink"></div>
  `;
}
/* ================= BUAT DOKUMEN (FINAL & STABIL) ================= */
async function buatDokumen(v){
  const d = dataList[index];
  const akhir = d.tgl_selesai || hitungAkhir(
    d.tgl_mulai,
    d.lama_cuti,
    d.cuti_bersama
  );

  loading.style.display = "block";
  docLink.innerHTML = "";

  const p = new URLSearchParams({
    versi: v,
    NAMA: d.nama,
    NIP: d.nip,
    JABATAN: d.jabatan || "",
    JENIS_CUTI: d.jenis_cuti,
    LAMA_CUTI: d.lama_cuti,
    AWAL_CUTI: d.tgl_mulai,
    AKHIR_CUTI: akhir,
    SISA_CUTI: d.sisa_cuti || "",
    NOMOR_SURAT: d.nomor_surat || "",
    ALAMAT: d.alamat || "",
    HP: d.no_hp || "",
    TTD: d.signature_url || ""
  });

  try {
    const r = await fetch(GAS_URL + "?" + p.toString());
    const j = await r.json();

    if (j && j.url) {
      // üîí URL PASTI DITERIMA DARI GAS
      lastDocUrl = j.url;
      lastDocName = j.name || "Dokumen Cuti";

      docLink.innerHTML =
        `üìÑ <a href="${lastDocUrl}" target="_blank">${lastDocName}</a>`;

      // buka otomatis
      window.open(lastDocUrl, "_blank");
    } else {
      docLink.innerHTML =
        "‚ö†Ô∏è Dokumen berhasil dibuat, tetapi URL tidak diterima.";
    }

  } catch (err) {
    docLink.innerHTML =
      "‚ö†Ô∏è Dokumen kemungkinan berhasil dibuat. Silakan cek Drive jika perlu.";
  } finally {
    loading.style.display = "none";
  }
}

/* ================= BUKA DOK TERAKHIR ================= */
function bukaDokTerakhir(){
  if(lastDocUrl){
    window.open(lastDocUrl,"_blank");
  }else{
    alert("Belum ada dokumen yang dibuat");
  }
}

/* ================= FUNGSI LAIN TIDAK DIUBAH ================= */
function nextData(){if(index<dataList.length-1){index++;render();}}
function prevData(){if(index>0){index--;render();}}
function setupSearch(){
  const input = document.getElementById("search");
  const box   = document.getElementById("suggestions");

  function fuzzyMatch(text, pattern){
    text = text.toLowerCase();
    pattern = pattern.toLowerCase();

    let ti = 0, pi = 0;
    while(ti < text.length && pi < pattern.length){
      if(text[ti] === pattern[pi]) pi++;
      ti++;
    }
    return pi === pattern.length;
  }

  input.oninput = () => {
    const q = input.value.trim();
    box.innerHTML = "";
    if(!q) return;

    dataList
      .filter(d => d.nama && fuzzyMatch(d.nama, q))
      .slice(0,7)
      .forEach(d => {
        const div = document.createElement("div");
        div.textContent = d.nama;
        div.onclick = () => {
          index = dataList.findIndex(x => x.id === d.id);
          render();
          box.innerHTML = "";
          input.value = d.nama;
        };
        box.appendChild(div);
      });
  };
}
loadAll();
async function simpan(){
  const d = dataList[index];
  if(!d || !d.id){
    alert("Data tidak valid");
    return;
  }

  // ambil input kanan
  const nomorSurat  = document.getElementById("nomor_surat").value.trim();
  const tglMulai    = document.getElementById("tgl_mulai").value;
  const lamaCuti    = parseInt(document.getElementById("lama_cuti").value || 0);
  const cutiBersama = parseInt(document.getElementById("cb").value || 0);
  const sisaCuti    = document.getElementById("sisa_cuti").value.trim();

  // hitung ulang akhir cuti
  const akhirCuti = hitungAkhir(tglMulai, lamaCuti, cutiBersama);

  const btn = event.target;
  btn.disabled = true;
  btn.textContent = "Menyimpan...";

  const { error } = await supabaseClient
    .from("pengajuan_cuti")
    .update({
      nomor_surat : nomorSurat,
      tgl_mulai   : tglMulai,
      lama_cuti   : lamaCuti,
      cuti_bersama: cutiBersama,
      sisa_cuti   : sisaCuti,
      tgl_selesai : akhirCuti
    })
    .eq("id", d.id);

  btn.disabled = false;
  btn.textContent = "Simpan";

  if(error){
    showToast("‚ùå Gagal menyimpan data", "error");
    return;
  }

  // update data lokal (ANTI HILANG SAAT REFRESH)
  d.nomor_surat   = nomorSurat;
  d.tgl_mulai     = tglMulai;
  d.lama_cuti     = lamaCuti;
  d.cuti_bersama  = cutiBersama;
  d.sisa_cuti     = sisaCuti;
  d.tgl_selesai   = akhirCuti;

  render();
  showToast("‚úÖ Data berhasil disimpan");
}
  function showToast(msg, type="success"){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "toast show" + (type==="error" ? " error" : "");
  setTimeout(()=>t.classList.remove("show"), 2500);
}
</script>
<div id="toast" class="toast"></div>
</body>
</html>
