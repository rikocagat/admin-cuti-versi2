<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DASBOARD ADMIN CUTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 16px;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 13px;
  text-align: center;
}
th {
  background: #0d6efd;
  color: #fff;
}
input, select {
  width: 100%;
  padding: 4px;
  font-size: 13px;
}
button {
  padding: 6px 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: #fff;
}
.btn-save { background: #198754; }
.btn-delete { background: #dc3545; }
</style>
</head>

<body>

<h1>DASBOARD ADMIN CUTI</h1>

<table>
<thead>
<tr>
  <th>Nama</th>
  <th>NIP</th>
  <th>Jenis Cuti</th>
  <th>Tgl Mulai</th>
  <th>Lama</th>
  <th>Tgl Selesai</th>
  <th>Cuti Bersama</th>
  <th>Status</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
/* =======================
   KONFIGURASI SUPABASE
======================= */
const SUPABASE_URL = "https://ufiqibxdgwlysqhinqbz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =======================
   LOAD DATA
======================= */
async function loadData() {
  const { data, error } = await supabase
    .from("pengajuan_cuti")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert("ERROR LOAD DATA: " + error.message);
    return;
  }

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.nama || ""}</td>
      <td>${row.nip || ""}</td>
      <td>${row.jenis_cuti || ""}</td>
      <td>${row.tgl_mulai || ""}</td>
      <td>${row.lama_cuti || ""}</td>

      <td>
        <input type="date" id="tgl_${row.id}" value="${row.tgl_selesai || ""}">
      </td>

      <td>
        <select id="cb_${row.id}">
          <option value="0" ${row.cuti_bersama == 0 ? "selected" : ""}>Tidak</option>
          <option value="1" ${row.cuti_bersama == 1 ? "selected" : ""}>Ya</option>
        </select>
      </td>

      <td>
        <select id="status_${row.id}">
          <option ${row.status === "Diajukan" ? "selected" : ""}>Diajukan</option>
          <option ${row.status === "Disetujui" ? "selected" : ""}>Disetujui</option>
          <option ${row.status === "Ditolak" ? "selected" : ""}>Ditolak</option>
        </select>
      </td>

      <td>
        <button class="btn-save" onclick="updateRow('${row.id}')">Simpan</button>
        <button class="btn-delete" onclick='deleteRow(${JSON.stringify(row)})'>Hapus</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* =======================
   UPDATE DATA
======================= */
async function updateRow(id) {
  const status = document.getElementById("status_" + id).value;
  const cuti_bersama = parseInt(document.getElementById("cb_" + id).value);
  const tgl_selesai = document.getElementById("tgl_" + id).value;

  const { error } = await supabase
    .from("pengajuan_cuti")
    .update({
      status: status,
      cuti_bersama: cuti_bersama,
      tgl_selesai: tgl_selesai
    })
    .eq("id", id);

  if (error) {
    alert("GAGAL UPDATE: " + error.message);
  } else {
    alert("Data berhasil diperbarui");
  }
}

/* =======================
   HAPUS DATA + STORAGE
======================= */
async function deleteRow(row) {
  if (!confirm("Yakin hapus data ini beserta file di storage?")) return;

  await deleteFile(row.file_1_url, "cuti-pdf");
  await deleteFile(row.file_2_url, "cuti-pdf");
  await deleteFile(row.signature_url, "cuti-signature");

  const { error } = await supabase
    .from("pengajuan_cuti")
    .delete()
    .eq("id", row.id);

  if (error) {
    alert("GAGAL HAPUS: " + error.message);
  } else {
    alert("Data & file berhasil dihapus");
    loadData();
  }
}

/* =======================
   HAPUS FILE STORAGE
======================= */
async function deleteFile(url, bucket) {
  if (!url) return;

  const path = url.split("/" + bucket + "/")[1];
  if (!path) return;

  await supabase
    .storage
    .from(bucket)
    .remove([path]);
}

/* =======================
   INIT
======================= */
loadData();
</script>

</body>
</html>
