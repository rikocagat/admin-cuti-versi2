<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>DASBOARD ADMIN CUTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:#eef1f5;
  margin:0;
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#0d6efd;
  color:#fff;
  padding:14px 20px;
}
header .left{
  display:flex;
  align-items:center;
  gap:12px;
}
.hamburger{
  font-size:22px;
  cursor:pointer;
}
.back-btn{
  background:#fff;
  color:#0d6efd;
  padding:6px 12px;
  border-radius:6px;
  text-decoration:none;
  font-weight:600;
}
main{padding:20px;}

.search-box{
  max-width:700px;
  margin:0 auto 15px auto;
  position:relative;
}
.search-box input{
  width:100%;
  padding:12px;
  font-size:16px;
}
.suggestions{
  position:absolute;
  background:#fff;
  width:100%;
  border:1px solid #ccc;
  max-height:220px;
  overflow-y:auto;
  z-index:100;
}
.suggestions div{
  padding:8px;
  cursor:pointer;
}
.suggestions div:hover{background:#e9ecef;}

.card{
  background:#fff;
  max-width:1200px;
  margin:20px auto;
  padding:24px;
  border-radius:10px;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px 40px;
}
.label{font-weight:600;margin-bottom:4px;}
input{
  width:100%;
  padding:8px;
  font-size:15px;
}

.files{
  margin-top:20px;
  padding-top:15px;
  border-top:1px solid #ddd;
}
.files-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:20px;
}
.files a{
  color:#0d6efd;
  font-weight:600;
}

.actions{
  margin-top:20px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.btn{
  padding:10px 18px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  color:#fff;
  font-size:15px;
}
.btn-save{background:#198754;}
.btn-doc{background:#6f42c1;}
.btn-nav{background:#0d6efd;}

.loading{
  display:none;
  margin-top:10px;
  font-weight:bold;
  color:#6f42c1;
}
.doc-link{
  margin-top:10px;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <div class="left">
    <span class="hamburger">‚ò∞</span>
    <a class="back-btn" href="https://rikoantah.github.io/Dasboard-Kepegawaian/">‚Üê Back</a>
  </div>
  <h2>DASBOARD ADMIN CUTI</h2>
</header>

<main>

<div class="search-box">
  <input type="text" id="search" placeholder="Cari nama pegawai...">
  <div class="suggestions" id="suggestions"></div>
</div>

<div class="card" id="card"></div>

<div class="actions" style="justify-content:center">
  <button class="btn btn-nav" onclick="prevData()">‚óÄ Sebelumnya</button>
  <button class="btn btn-nav" onclick="nextData()">Berikutnya ‚ñ∂</button>
</div>

</main>

<script>
const SUPABASE_URL="https://ufiqibxdgwlysqhinqbz.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL";
const GAS_URL="https://script.google.com/macros/s/AKfycbwo6wwtU0nqbYRqD_m4eNiCBgLYS6utiSmK_tv1TRTUoz0YXaIENW7ivROQPHHbzS9B/exec";

const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let dataList=[],index=0;

/* HITUNG AKHIR CUTI */
function hitungAkhir(tglMulai,lama,cb){
  let t=new Date(tglMulai),h=0;
  while(h<lama){
    let d=t.getDay();
    if(d!==0&&d!==6)h++;
    if(h<lama)t.setDate(t.getDate()+1);
  }
  let add=parseInt(cb||0);
  while(add>0){
    t.setDate(t.getDate()+1);
    let d=t.getDay();
    if(d!==0&&d!==6)add--;
  }
  return t.toISOString().split("T")[0];
}

/* LOAD DATA */
async function loadAll(){
  const {data}=await supabaseClient
    .from("pengajuan_cuti")
    .select("*")
    .order("created_at",{ascending:false});
  dataList=data||[];
  render();
  setupSearch();
}

/* RENDER */
function render(){
  const d=dataList[index];
  if(!d)return;

  const akhir=hitungAkhir(d.tgl_mulai,d.lama_cuti,d.cuti_bersama);

  document.getElementById("card").innerHTML=`
    <div class="grid">
      <div><div class="label">Nama</div>${d.nama}</div>
      <div><div class="label">NIP</div>${d.nip}</div>

      <div><div class="label">Jabatan</div>${d.jabatan||"-"}</div>
      <div><div class="label">No HP</div>${d.no_hp}</div>

      <div><div class="label">Jenis Cuti</div>${d.jenis_cuti}</div>
      <div><div class="label">Alamat</div>${d.alamat}</div>

      <div>
        <div class="label">Cuti Bersama (hari)</div>
        <input type="number" id="cb" value="${d.cuti_bersama||0}">
      </div>
      <div>
        <div class="label">Sisa Cuti</div>
        <input type="number" id="sisa">
      </div>

      <div>
        <div class="label">Akhir Cuti</div>
        <b id="akhir">${akhir}</b>
      </div>
    </div>

    <div class="files">
      <div class="label">Berkas & Tanda Tangan</div>
      <div class="files-grid">
        <div>
          <div class="label">Persyaratan 1</div>
          ${d.file_1_url ? `<a href="${d.file_1_url}" target="_blank">Lihat Berkas</a>` : "-"}
        </div>
        <div>
          <div class="label">Persyaratan 2</div>
          ${d.file_2_url ? `<a href="${d.file_2_url}" target="_blank">Lihat Berkas</a>` : "-"}
        </div>
        <div>
          <div class="label">TTD</div>
          ${d.signature_url ? `<a href="${d.signature_url}" target="_blank">Lihat TTD</a>` : "-"}
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-save" onclick="simpan()">Simpan</button>
      <button class="btn btn-doc" onclick="buatDokumen(1)">Buat Dokumen V1</button>
      <button class="btn btn-doc" onclick="buatDokumen(2)">Buat Dokumen V2</button>
    </div>

    <div class="loading" id="loading">‚è≥ Membuat dokumen...</div>
    <div class="doc-link" id="docLink"></div>
  `;
}

/* SIMPAN */
async function simpan(){
  const d=dataList[index];
  const cb=parseInt(document.getElementById("cb").value||0);
  const akhir=hitungAkhir(d.tgl_mulai,d.lama_cuti,cb);

  await supabaseClient
    .from("pengajuan_cuti")
    .update({cuti_bersama:cb,tgl_selesai:akhir})
    .eq("id",d.id);

  d.cuti_bersama=cb;
  d.tgl_selesai=akhir;
  document.getElementById("akhir").innerText=akhir;
  alert("Perubahan disimpan");
}

/* BUAT DOKUMEN */
async function buatDokumen(v){
  const d=dataList[index];
  const sisa=document.getElementById("sisa").value||"";
  const cb=document.getElementById("cb").value||0;
  const akhir=hitungAkhir(d.tgl_mulai,d.lama_cuti,cb);

  document.getElementById("loading").style.display="block";
  document.getElementById("docLink").innerHTML="";

  const p=new URLSearchParams({
    versi:v,
    NAMA:d.nama,
    NIP:d.nip,
    JABATAN:d.jabatan||"",
    JENIS_CUTI:d.jenis_cuti,
    LAMA_CUTI:d.lama_cuti,
    AWAL_CUTI:d.tgl_mulai,
    AKHIR_CUTI:akhir,
    SISA_CUTI:sisa,
    ALAMAT:d.alamat,
    HP:d.no_hp,
    TTD:d.signature_url
  });

  const r=await fetch(GAS_URL+"?"+p.toString());
  const j=await r.json();
  document.getElementById("loading").style.display="none";

  if(j.success){
    document.getElementById("docLink").innerHTML=
      `üìÑ Dokumen: <a href="${j.url}" target="_blank">${j.name}</a>`;
  }else alert("Gagal membuat dokumen");
}

/* NAVIGASI */
function nextData(){if(index<dataList.length-1){index++;render();}}
function prevData(){if(index>0){index--;render();}}

/* SEARCH */
function setupSearch(){
  const i=document.getElementById("search"),s=document.getElementById("suggestions");
  i.addEventListener("input",()=>{
    s.innerHTML="";
    dataList.filter(d=>d.nama.toLowerCase().includes(i.value.toLowerCase()))
    .slice(0,7).forEach(d=>{
      const div=document.createElement("div");
      div.textContent=d.nama;
      div.onclick=()=>{
        index=dataList.findIndex(x=>x.id===d.id);
        render();s.innerHTML="";
      };
      s.appendChild(div);
    });
  });
}

loadAll();
</script>

</body>
</html>
